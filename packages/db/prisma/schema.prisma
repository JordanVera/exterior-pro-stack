generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ─── Enums ──────────────────────────────────────────────────────────────────

enum UserRole {
  CUSTOMER
  PROVIDER
  ADMIN
}

enum BidStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  WITHDRAWN
}

enum JobStatus {
  OPEN
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum JobType {
  ONE_TIME
  SUBSCRIPTION
}

enum RecurringFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  BIANNUALLY
}

enum ServiceFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  BIANNUALLY
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  PAST_DUE
}

enum BillingFrequency {
  MONTHLY
  QUARTERLY
  ANNUALLY
}

enum PriceUnit {
  SQFT
  HOUR
  FLAT
}

enum NotificationType {
  NEW_JOB_AVAILABLE
  BID_RECEIVED
  BID_ACCEPTED
  BID_DECLINED
  JOB_SCHEDULED
  JOB_IN_PROGRESS
  JOB_COMPLETED
  JOB_CANCELLED
  JOB_REMINDER
  SCHEDULE_CHANGE
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_RENEWED
  SUBSCRIPTION_CANCELLED
  NEW_PROVIDER_SIGNUP
  GENERAL
}

// ─── Core User ──────────────────────────────────────────────────────────────

model User {
  id        String    @id @default(cuid())
  phone     String    @unique
  role      UserRole?
  verified  Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  customerProfile CustomerProfile?
  providerProfile ProviderProfile?
  notifications   Notification[]
  pushTokens      PushToken[]
}

// ─── Profiles ───────────────────────────────────────────────────────────────

model CustomerProfile {
  id               String   @id @default(cuid())
  userId           String   @unique
  firstName        String
  lastName         String
  email            String?
  stripeCustomerId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  properties    Property[]
  subscriptions CustomerSubscription[]
}

model ProviderProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  businessName    String
  description     String?  @db.Text
  serviceArea     String?
  serviceAreaZips String?
  verified        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  bids          JobBid[]
  crews         Crew[]
  services      ProviderService[]
  subscriptions CustomerSubscription[]
}

// ─── Properties ─────────────────────────────────────────────────────────────

model Property {
  id         String   @id @default(cuid())
  customerId String
  address    String
  city       String
  state      String
  zip        String
  notes      String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer      CustomerProfile      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  jobs          Job[]
  subscriptions CustomerSubscription[]
}

// ─── Service Catalog ────────────────────────────────────────────────────────

model ServiceCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?  @db.Text
  icon        String?
  image       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  services Service[]
}

model Service {
  id          String    @id @default(cuid())
  categoryId  String
  name        String
  description String?   @db.Text
  basePrice   Decimal   @db.Decimal(10, 2)
  unit        PriceUnit @default(FLAT)
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  category         ServiceCategory   @relation(fields: [categoryId], references: [id])
  providerServices ProviderService[]
  planServices     PlanService[]
  jobs             Job[]
}

model ProviderService {
  id          String   @id @default(cuid())
  providerId  String
  serviceId   String
  customPrice Decimal? @db.Decimal(10, 2)

  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  service  Service         @relation(fields: [serviceId], references: [id])

  @@unique([providerId, serviceId])
}

// ─── Subscription Plans ─────────────────────────────────────────────────────

model SubscriptionPlan {
  id                     String   @id @default(cuid())
  name                   String   @unique
  description            String?  @db.Text
  monthlyPrice           Decimal  @db.Decimal(10, 2)
  quarterlyPrice         Decimal? @db.Decimal(10, 2)
  annualPrice            Decimal? @db.Decimal(10, 2)
  active                 Boolean  @default(true)
  stripeProductId        String?
  stripePriceIdMonthly   String?
  stripePriceIdQuarterly String?
  stripePriceIdAnnually  String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  services      PlanService[]
  subscriptions CustomerSubscription[]
}

model PlanService {
  id        String           @id @default(cuid())
  planId    String
  serviceId String
  frequency ServiceFrequency

  plan    SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  service Service          @relation(fields: [serviceId], references: [id])

  @@unique([planId, serviceId])
}

model CustomerSubscription {
  id                   String             @id @default(cuid())
  customerId           String
  planId               String
  propertyId           String
  status               SubscriptionStatus @default(ACTIVE)
  billingFrequency     BillingFrequency   @default(MONTHLY)
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  stripeSubscriptionId String?
  assignedProviderId   String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  customer CustomerProfile  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  plan     SubscriptionPlan @relation(fields: [planId], references: [id])
  property Property         @relation(fields: [propertyId], references: [id])
  provider ProviderProfile? @relation(fields: [assignedProviderId], references: [id])
  jobs     Job[]
}

// ─── Jobs & Bids ────────────────────────────────────────────────────────────

model Job {
  id             String    @id @default(cuid())
  propertyId     String
  serviceId      String
  type           JobType   @default(ONE_TIME)
  status         JobStatus @default(OPEN)
  subscriptionId String?
  acceptedBidId  String?   @unique
  customerNotes  String?   @db.Text
  scheduledDate  DateTime?
  scheduledTime  String?
  completedAt    DateTime?
  notes          String?   @db.Text
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  property          Property              @relation(fields: [propertyId], references: [id])
  service           Service               @relation(fields: [serviceId], references: [id])
  subscription      CustomerSubscription? @relation(fields: [subscriptionId], references: [id])
  acceptedBid       JobBid?               @relation("AcceptedBid", fields: [acceptedBidId], references: [id])
  bids              JobBid[]              @relation("JobBids")
  assignments       JobAssignment[]
  recurringSchedule RecurringSchedule?
}

model JobBid {
  id         String    @id @default(cuid())
  jobId      String
  providerId String
  price      Decimal   @db.Decimal(10, 2)
  notes      String?   @db.Text
  status     BidStatus @default(PENDING)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  job            Job             @relation("JobBids", fields: [jobId], references: [id], onDelete: Cascade)
  provider       ProviderProfile @relation(fields: [providerId], references: [id])
  acceptedForJob Job?            @relation("AcceptedBid")

  @@unique([jobId, providerId])
}

// ─── Crews ──────────────────────────────────────────────────────────────────

model Crew {
  id         String   @id @default(cuid())
  providerId String
  name       String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  members     CrewMember[]
  assignments JobAssignment[]
}

model CrewMember {
  id        String   @id @default(cuid())
  crewId    String
  name      String
  phone     String?
  role      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  crew Crew @relation(fields: [crewId], references: [id], onDelete: Cascade)
}

// ─── Scheduling ─────────────────────────────────────────────────────────────

model JobAssignment {
  id         String   @id @default(cuid())
  jobId      String
  crewId     String
  assignedAt DateTime @default(now())

  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  crew Crew @relation(fields: [crewId], references: [id])

  @@unique([jobId, crewId])
}

model RecurringSchedule {
  id        String             @id @default(cuid())
  jobId     String             @unique
  frequency RecurringFrequency
  nextDate  DateTime
  active    Boolean            @default(true)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

// ─── Notifications ──────────────────────────────────────────────────────────

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  body      String           @db.Text
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
}

// ─── Auth ───────────────────────────────────────────────────────────────────

model VerificationCode {
  id        String   @id @default(cuid())
  phone     String
  code      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone, code])
}

// ─── Push Tokens ────────────────────────────────────────────────────────────

model PushToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  platform  String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
